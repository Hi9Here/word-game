<link rel="import" href="/bower_components/mdl-template-dash/mdl-template-dash.html">
<link rel="import" href="/bower_components/firebase-ui-auth/firebase-ui-auth.html">
<link rel="import" href="/bower_components/file-upload/file-upload.html">
<link rel="import" href="/bower_components/polymer/polymer.html">
<!--
  `<word-game></word-game>` Word game using firebase as a backend and Google Cloud vision for input.
  @demo demo.html
-->
<dom-module id="word-game">
  <template>
    <style>:host {display:block;}</style>
    
    <template is="dom-if" if="[[got]]">
      You have got
      <template is="dom-repeat" items="{{got}}">[[item]]<br></template>
    </template>
   
    <firebase-ui-auth hidden="[[user.uid]]" user="{{user}}"></firebase-ui-auth>

    <template is="dom-if" if="[[user.uid]]">
      upload a pic of
      <template is="dom-repeat" items="{{words}}">
        <div>
          [[item]]
        </div>
      </template>
      <file-upload ></file-upload>
    </template>

    <template is="dom-if" if="[[items]]">
      pics so far
      <template is="dom-repeat" items="{{items}}">
        <div>
          <img src="[[item.url]]" style="max-height:200px"/>
          [[item.words]]
        </div>
      </template>
    </template> 
  </template>
</dom-module>
<script>
  Polymer({
    is: "word-game",
    properties:{
      words:{
        type: Array,
        value: ["cup","computer","joy","angry","floor","hand","bicycle","light"],
      },
      _filesID:{
        computed:"getFiles(user.uid)",
      },
      _getItems: {
        computed:"getItems(user.uid, filesID)",
      },
      items:{
        value: []
      },
    },
    getFiles: function(uid){
      var that = this
      var db = firebase.firestore()
      var user = db.collection("Users").doc(uid)
      // set user name
      user.onSnapshot(function(doc) {
        console.log("Current data: ", doc && doc.data())
        that.filesID = Object.keys(doc.data().files)
      })
    },
    getItems: function(uid, filesID) {
      var that = this
      var db = firebase.firestore()
      
      var index
      for (index = filesID.length - 1; index >= 0; --index) {
        db.collection("files").doc(filesID[index]).get().then(function(file) {
          var words = file.data().vision[0].labelAnnotations.map(function(label) {
            return label.description
          })
          firebase.storage().ref().child(file.data().path).getDownloadURL().then(function(url) {
            that.push("items",{url: url, words: words})
            var wordIndex
            var thatWordsIndex
            for (wordIndex = words.length - 1; wordIndex >= 0; --wordIndex) {
              for (thatWordsIndex = that.words.length - 1; thatWordsIndex >= 0; --thatWordsIndex) {
                if (that.words[thatWordsIndex].toLowerCase() === words[wordIndex].toLowerCase()) {
                  that.words.splice(thatWordsIndex,1)
                  that.push("got",words[wordIndex])
                }               
              }
            }
          })
        })
      }
    },
  })
</script>
